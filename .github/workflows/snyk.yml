# Snyk 脆弱性スキャン（push/PR 時に自動実行）
# - 依存関係: test + monitor（monitor で Snyk にスナップショット送信 → Fix PR の元になる）
# - 既存の脆弱性にも PR を出したい場合: Snyk 管理画面で「Backlog PRs」を有効にすること。
#   （Fix PRs = 新規検出時のみ / Backlog PRs = 既知のバックログにも PR を自動作成）
# - コード: Snyk Code でソースコードをスキャンし、結果を SARIF で Issue 1 件を自動作成（リファクタ用バックログ・マイルストーン QA に紐付け。コードの自動修正はされない）
# 事前に GitHub Secrets に SNYK_TOKEN を登録してください。

name: Snyk security scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  snyk-frontend:
    name: Snyk (Frontend / Node)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node and install dependencies
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
        working-directory: frontend

      - name: Snyk test (Node)
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=frontend/package.json
        continue-on-error: true

      - name: Snyk monitor (Node) – スナップショット送信（Fix PR 用）
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --file=frontend/package.json
        continue-on-error: true

  snyk-backend:
    name: Snyk (Backend / Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python and install dependencies
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt
      - run: pip install -r requirements.txt
        working-directory: backend

      - name: Install Snyk CLI
        uses: snyk/actions/setup@master

      - name: Snyk test (Python)
        run: snyk test --file=backend/requirements.txt
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - name: Snyk monitor (Python) – スナップショット送信（Fix PR 用）
        run: snyk monitor --file=backend/requirements.txt
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

  snyk-code:
    name: Snyk Code（ソースコードスキャン）
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Snyk CLI
        uses: snyk/actions/setup@master

      - name: Snyk Code test（SARIF 出力）
        run: snyk code test --sarif-file-output=snyk-code.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - name: Snyk Code 結果を GitHub Issue で起票（リファクタ用バックログ）
        id: snyk-issue
        if: always() && hashFiles('snyk-code.sarif') != ''
        uses: sett-and-hive/sarif-to-issue-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          branch: ${{ github.head_ref || github.ref_name }}
          sarif-file: snyk-code.sarif
          title: "Snyk Code スキャン結果（セキュリティ・リファクタ用）"
          labels: security
          dry-run: false

      - name: 起票した Issue をマイルストーン「Quality Assurance」に紐付け
        if: steps.snyk-issue.outcome == 'success'
        run: |
          ISSUE_NO=$(gh issue list \
            --search "Snyk Code スキャン結果 in:title repo:${{ github.repository }}" \
            --state open --limit 10 \
            --json number,createdAt -q 'sort_by(.createdAt) | reverse | .[0].number // empty')
          if [ -n "$ISSUE_NO" ]; then
            gh issue edit "$ISSUE_NO" --milestone "Quality Assurance"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
