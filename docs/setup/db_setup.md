# はじめに
*本手順は、[setup.md](./setup.md)の『2. バックエンド環境のセットアップ』が終了してから実施すること*

# データベース管理（Alembic）ガイド

このプロジェクトでは、データベース（MySQL）の形を管理するために **Alembic（アレンビック）** というツールを使っています。

## 1. Alembicとは？

一言で言うと、**「データベースの履歴管理（タイムマシン）ツール」** です。

通常、データベースのテーブルを作ったり変更したりするにはSQLを書きますが、複数人で開発していると「AさんのPCにはテーブルがあるけど、BさんのPCにはない」といったズレが起きてしまいます。
Alembicを使うと、**「誰が、いつ、どんなテーブルを作ったか」をPythonファイルとして記録**し、チーム全員で共有・再現できるようになります。

---

## 2. 全体の仕組み

私たちがコードを書くと、以下の3つが連動して動きます。

1. **SQLAlchemyモデル (`app/models/*.py`)**: 「こんなテーブルが欲しい」というPythonでの設計図。
2. **Alembicマイグレーションファイル (`alembic/versions/*.py`)**: 変更の履歴。Gitで共有します。
3. **実際のデータベース (MySQL)**: 実際にデータが保存される場所。

---

## 3. 開発の流れ（シチュエーション別）

### ケースA：最新のDB状態を自分のPCに反映したい

（例：新しくプロジェクトに参加した、または他のメンバーがテーブルを追加した時）

```bash
cd backend
# 仮想環境を起動してから実行
alembic upgrade head

```

* **何が起きる？**: まだ自分のPCに作られていないテーブルが、自動でMySQLに作成されます。

### ケースB：自分でテーブルやカラムを追加したい

（例：ユーザー情報のテーブルに「住所」カラムを増やしたい時）

1. **モデルを編集**: `app/models/user.py` に新しい項目を書き足します。
2. **設計図を生成**:
```bash
alembic revision --autogenerate -m "Add address to user"

```


* これで `alembic/versions/` 内に新しい履歴ファイルができます。


3. **DBに反映**:
```bash
alembic upgrade head

```



---

## 4. 各ディレクトリ・ファイルの役割

| ファイル/場所 | 役割 | 開発者がやること |
| --- | --- | --- |
| **`app/models/`** | データベースの「あるべき姿」を定義。 | ここを編集してテーブル構造を決める。 |
| **`alembic/versions/`** | 過去から現在までの変更履歴ファイル。 | `git pull` でここが増えたら `upgrade` を実行。 |
| **`alembic/env.py`** | Alembicとアプリを繋ぐ設定ファイル。 | 基本は触りませんが、接続エラー時に確認します。 |
| **`alembic.ini`** | ツール全体の設定。 | 基本は触りません。 |

---

## 5. メンバーへの注意点

* **直接MySQLを操作しない**:
MySQL Workbenchなどで直接テーブルを作ってしまうと、Alembicの履歴とズレてしまい、後でエラーになります。必ず「モデルを修正 → Alembicで反映」のルールを守りましょう。
* **`__init__.py` を忘れない**:
新しいモデルファイル（例: `product.py`）を作ったら、`app/models/__init__.py` にインポートを追記してください。これがないと、Alembicが新しいテーブルに気づいてくれません。
* **`.env` は共有しない**:
自分のパスワードが書いてあるので、Gitには上げないように気をつけてください（`.gitignore` で対策済みです）。



## 補足：DBの接続先はどこで決まる？

プログラムが「どのMySQLに繋ぎにいくか」は、以下の**3つのステップ**で決まっています。

### 1. `.env` ファイル（情報の源泉）

まず、皆さんの手元にある `.env` ファイルに書かれた `DATABASE_URL` がすべての出発点です。

* **ローカル開発時**: `localhost`（自分のPC）を指します。
* **本番運用時**: Azureのサーバーアドレスを指します。

### 2. `app/db.py` と `alembic/env.py`（読み取り役）

次に、Pythonプログラムがこの `.env` を読み取ります。

* **APIを実行するとき**: `app/db.py` がURLを読み取り、SQLAlchemyエンジンを作成してデータを操作します。
* **テーブルを作成するとき**: `alembic/env.py` がURLを読み取り、Alembicに「このDBにテーブルを作って！」と命令します。

### 3. 環境変数という仕組み

プログラムの中に直接パスワードを書くと、GitHubに公開されてしまい危険です。そのため、**「パスワードは `.env` に隠しておき、プログラムは実行時にそれを『環境変数』として取り出す」**という安全な方法をとっています。

> **メンバーへのアドバイス**:
> 「DBに繋がらない！」と思ったら、まずは `.env` のパスワードやDB名が自分のMySQLの設定と合っているかを確認しましょう。
