# 基本要件定義書

**プロダクトレベルの前提（誰に・何の価値・どの課題を解決するか）は別紙 [プロダクトビジョン](./プロダクトビジョン.md) を参照すること。**

---

**📝 レビュー依頼**: 本ドキュメントのレビューをお願いします。PR上でコメントいただけると助かります。

---

## 1. プロジェクト概要

### 目的
12期生が作成した家計簿アプリ（gen12）を土台に、11期各チームが **Step3-2 で培ったプロダクトのエッセンス**（くんよみ・MOF・wasabimonja 等の知見や機能アイデア）を反映し、**家計簿アプリとしての質**を一段高める。その結果物を 12期生に示し、「半年後の姿」として技術と開発のレベル感を伝える。

### 技術スタック
- **フロントエンド**: Next.js + TypeScript + Tailwind CSS
- **バックエンド**: FastAPI + Python
- **データベース**: Azure MySQL
- **デプロイ**: Azure
- **AI機能**: OpenAI API（継続利用）

---

## 2. 機能要件

機能のサマリは別紙 [機能一覧](./機能一覧.md) を参照。

### 2.1. 必須機能（Sprint 1で完了目標）

gen12の機能を11期レベルで再実装する。認証により、支出・分析をログインユーザーに紐づける。

#### 2.1.1. 認証機能
- **概要**: ログイン・サインアップ・セッション管理。支出記録・分析を「ログイン中のユーザー」に紐づける。
- **エンドポイント（例）**:
  - `POST /api/auth/signup`（サインアップ）
  - `POST /api/auth/login`（ログイン）
  - `POST /api/auth/logout`（ログアウト）
  - `GET /api/auth/me`（現在ユーザー取得）
- **機能詳細**:
  - メールアドレス（またはユーザーID）とパスワードによる認証
  - セッションまたはJWTによる認証状態の保持
  - 未認証時はログイン画面へリダイレクト（またはログイン促し）
- **gen12との違い**: gen12はユーザー名の入力のみ。本アプリでは認証により「誰のデータか」を一意にし、他ユーザーのデータを参照・改ざんできないようにする。

- **まつこめ**
  - 以下の課題があるため、最初から「Google認証のみ」の設計にするのがよいと思います。
    > 課題(AI解説)：  
    >「セッション or JWT」が曖昧で、ログイン方式の対応範囲が決められない。
    >  現状だと「セッションでもJWTでもOK」になっていて、結果として以下が未決定です。ここが決まっていないと、後から追加すると実装もDBもAPIも手戻りします。
  - フロントはどこに認証状態を持つ？（Cookie / localStorage / メモリ）
  - バックエンドはどう検証する？（サーバーセッション照合 / JWT署名検証）
  - ログアウト時に何を無効化する？（サーバー側セッション破棄 / トークン失効リスト / リフレッシュトークン破棄）
  - OAuth（Google）を入れられる設計なのか？

  > 推奨方式:  
  > Google OAuth + サーバー側セッション + HttpOnly Cookie（14日）  
  > おすすめ理由: パスワード管理が不要、Cookie期限を延ばすだけでログイン維持ができる。
  > ローカルにトークンを置かないため、XSS耐性を上げやすい。
  - Googleでログイン（ID連携）
  - バックエンドが「この人はOK」を確認
  - バックエンドが セッションID を発行して HttpOnly Cookie に保存（Max-Age=14日とか）
  - 以後、APIはCookieで認証（/meも同じ）



#### 2.1.2. 支出記録機能
- **概要**: ユーザー名、アイテム名、金額を入力して記録
- **エンドポイント**: `POST /api/expenses`
- **機能詳細**:
  - ユーザー名、アイテム名、金額の入力
  - 日付の自動記録（入力が無い場合は、現在日時）
  - データベースへの保存
- **gen12との違い**:
  - CSV → データベース（Azure MySQL）に変更
  - 型安全性の確保（TypeScript + Pydantic）
  - エラーハンドリングの強化
- **まつこめ**
  - プロト#1としてはOK
  - 誤投稿時に修正できる機能追加も見据えたコード設計ができると尚良いと思います。
  - 日付ですが、12期プロダクトでもUIから入力可能にしていました。「入力日付が無い場合のみ現在日次」が正しいと思います。（上記、修正済み）

#### 2.1.3. 分析機能（AIコーチング）
- **概要**: ユーザー別の合計金額を計算し、AIコーチングを提供
- **エンドポイント**: `GET /api/analyze?user={user}&coach={coach}`
- **機能詳細**:
  - 指定ユーザーの合計金額を計算
  - AIコーチング機能（鬼コーチ/天使コーチ）
  - 目標支出額との比較
- **コーチタイプ**:
  - `oni`: 鬼コーチ（厳しい指導）
  - `tenshi`: 天使コーチ（優しい指導）
- **gen12との違い**:
  - データベースからの集計（CSV → DB）
  - 予算設定の柔軟化（ハードコード → DB保存）
- **まつこめ**
  - 改善レベルの案ですが、「この人は、こういう家族構成・こういう職業だから」のような  コンテキストも与えて出力できる設計にすると、より精度が上がると思います。
  - 今は分析ボタンを押す設計ですが、自動でメールかLINEなど送られてくる設計の方がUX的に良さそう（面白そう）
  - **重要:** サーバー側で認証するので、フロントからユーザー名を指定できる設計だと他のユーザーを見れていない問題が出そうです。最終形では、ユーザーはフロントから指定せず、バックエンドが判定する仕様になると思います。


#### 2.1.4. 基本UI
- **概要**: 支出記録と分析結果を表示する画面
- **画面構成**:
  - 入力フォーム（ユーザー名、アイテム名、金額）
  - 分析ボタン（鬼コーチ/天使コーチ）
  - 結果表示エリア
- **gen12との違い**:
  - モダンなUI/UX（Next.js + Tailwind CSS）
  - レスポンシブ対応
  - 型安全なコンポーネント（TypeScript）
- **まつこめ**
  - ユーザー識別は、入力させずログイン状態から読み取るかたちにさせたい。
  - ただ、「xxx@gmail.comさん」という表示はイケてないので、表示のためにユーザー名を登録する機能はつけたい。⇒DBのuserテーブルに、nicknameフィールドを追加した方がよさそう。


### 2.2. 追加実装機能（Sprint 2以降）

#### 2.2.1. 履歴表示機能
- **概要**: 記録した支出の一覧を表示
- **エンドポイント**: `GET /api/expenses?user={user}`
- **機能詳細**:
  - ユーザー別の支出履歴一覧
  - 日付順でのソート
  - ページネーション（必要に応じて）

#### 2.2.2. 予算設定機能
- **概要**: ユーザーごとの月次予算を設定・管理
- **エンドポイント**: 
  - `POST /api/budgets`（予算設定）
  - `GET /api/budgets?user={user}`（予算取得）
- **機能詳細**:
  - 月次予算の設定・更新
  - 予算と実績の比較表示
  - 予算超過時のアラート

#### 2.2.3. レシート画像の自動認識・入力（11期機能統合）
- **概要**: レシート画像を撮影して支出情報を自動入力
- **エンドポイント**: `POST /api/receipts/analyze`
- **機能詳細**:
  - 画像ファイル（PNG, JPG, JPEG）のアップロード
  - GPT-4 Vision APIによる画像解析
  - アイテム名、金額、日付の自動抽出
  - 抽出結果の確認・編集機能
- **実装参考**: MOFの`pdf_analyzer.py`と`ai_judge.py`
- **優先度**: ⭐⭐⭐⭐⭐（最高優先度）

#### 2.2.4. サービス名正規化機能（11期機能統合）
- **概要**: CSV解析時のサービス名を正規化して検出精度を向上
- **機能詳細**:
  - 500以上のサービス名マッピング（Netflix, Spotify, Adobe等）
  - 表記揺れ対応（全角/半角、記号統一）
  - 部分一致検索（誤爆防止機能付き）
- **実装参考**: wasabimonjaの`normalize_service_name`関数
- **優先度**: ⭐⭐⭐⭐⭐（最高優先度）

#### 2.2.5. 明細書解析機能の拡張（11期機能統合）
- **概要**: PDF・画像・CSVの統合解析と定期性パターン検出
- **エンドポイント**: `POST /api/analyze/files`（拡張版）
- **機能詳細**:
  - PDF明細書の解析対応（PyMuPDF使用）
  - 画像明細書の解析対応（OCR精度向上処理付き）
  - CSVから自動で定期支払いを検出（月次間隔25-35日）
  - 未知のサブスク発見機能
- **実装参考**: wasabimonjaの明細書解析機能
- **優先度**: ⭐⭐⭐⭐（高優先度）
- **まつこめ**
  - 画像はOCR処理時に必要パラメータを読み取って保存。画像データは保存しない方が良いと思います。（ストレージ消費、個人情報漏洩対策のため）

#### 2.2.6. 評価機能（11期機能統合）
- **概要**: 各支出アイテムに対して「役立ったか」を評価
- **エンドポイント**: 
  - `POST /api/expenses/{expense_id}/evaluate`
  - `GET /api/expenses/{expense_id}/evaluation`
- **機能詳細**:
  - 支出アイテムごとの評価（役立った/役立たなかった）
  - 評価スコアの集計・表示
  - 「おすすめの支出」機能（評価スコアに基づく）
  - 満足度の高い支出パターンの分析
- **実装参考**: くんよみの`DocumentEvaluation`モデル
- **優先度**: ⭐⭐⭐⭐⭐（高優先度）

#### 2.2.7. カテゴリ分類機能（11期機能統合）
- **概要**: 支出をカテゴリで分類・管理
- **エンドポイント**: 
  - `GET /api/categories`
  - `POST /api/categories`
  - `PUT /api/expenses/{expense_id}/category`
- **機能詳細**:
  - カテゴリマスターの管理（階層構造対応）
  - 支出記録時のカテゴリ選択
  - カテゴリ別の支出集計
  - カテゴリごとの予算管理
- **実装参考**: くんよみの`genres`テーブル構造
- **優先度**: ⭐⭐⭐⭐（中優先度）

#### 2.2.8. キーワード検索機能（11期機能統合）
- **概要**: 支出履歴のキーワード検索
- **エンドポイント**: `GET /api/expenses/search?keyword={keyword}`
- **機能詳細**:
  - キーワードによる支出履歴の検索
  - 正規化処理により表記揺れに対応（「コーヒー」「coffee」等を同一視）
  - 検索結果のハイライト表示
- **実装参考**: くんよみのキーワード検索機能
- **優先度**: ⭐⭐⭐⭐（中優先度）

#### 2.2.9. 検出履歴管理（11期機能統合）
- **概要**: 明細書解析結果の履歴を保存・参照
- **エンドポイント**: 
  - `GET /api/detection-histories`
  - `GET /api/detection-histories/{history_id}`
  - `PUT /api/detection-histories/{history_id}`
- **機能詳細**:
  - 解析履歴の保存（アップロードファイル数、検出数、合計金額等）
  - 履歴一覧の表示（ページネーション対応）
  - 履歴詳細の表示
  - 解約ステータスの管理（チェックボックス）
- **実装参考**: wasabimonjaの`DetectionHistory`モデル
- **優先度**: ⭐⭐⭐⭐（中優先度）

#### 2.2.10. レポート機能（オプション）
- **概要**: 月次/年次の支出レポート
- **機能詳細**:
  - 月次集計の表示
  - グラフ表示（チャートライブラリ使用）
  - トレンド分析

---

## 3. データモデル

データモデル・テーブル定義は [docs/design/テーブル定義.md](../design/テーブル定義.md) を参照すること。

---

## 4. API設計

### 4.1. 支出記録API
- **エンドポイント**: `POST /api/expenses`
- **リクエストボディ**:
  ```json
  {
    "item": "コーヒー",
    "price": 500
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": 1,
    "user_id": 1,
    "item": "コーヒー",
    "price": 500,
    "expense_date": "2026-01-28",
    "created_at": "2026-01-28T10:00:00Z"
  }
  ```
- **エラーハンドリング**:
  - 400: バリデーションエラー（必須項目不足、型不一致等）
  - 401: 未認証
  - 500: サーバーエラー

### 4.2. 分析API
- **エンドポイント**: `GET /api/analyze?user={user}&coach={coach}`
- **クエリパラメータ**:
  - `user`: ユーザー名（必須）
  - `coach`: コーチタイプ（`oni` または `tenshi`、必須）
- **レスポンス**:
  ```json
  {
    "user": "しゅんすけ",
    "total": 15000,
    "budget": 20000,
    "coach_message": "よく頑張っています！..."
  }
  ```
- **エラーハンドリング**:
  - 400: パラメータ不足
  - 404: ユーザーが見つからない
  - 500: サーバーエラー

### 4.3. 履歴取得API（追加機能）
- **エンドポイント**: `GET /api/expenses?user={user}`
- **クエリパラメータ**:
  - `user`: ユーザー名（必須）
  - `page`: ページ番号（オプション、デフォルト: 1）
  - `per_page`: 1ページあたりの件数（オプション、デフォルト: 20）
- **レスポンス**:
  ```json
  {
    "expenses": [
      {
        "id": 1,
        "item": "コーヒー",
        "price": 500,
        "expense_date": "2026-01-28"
      }
    ],
    "total": 100,
    "page": 1,
    "per_page": 20
  }
  ```

### 4.4. 予算設定API（追加機能）
- **エンドポイント**: `POST /api/budgets`
- **リクエストボディ**:
  ```json
  {
    "monthly_budget": 20000
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": 1,
    "user_id": 1,
    "monthly_budget": 20000,
    "created_at": "2026-01-28T10:00:00Z"
  }
  ```

### 4.5. レシート画像解析API（11期機能統合）
- **エンドポイント**: `POST /api/receipts/analyze`
- **リクエスト**:
  - Content-Type: `multipart/form-data`
  - `file`: 画像ファイル（PNG, JPG, JPEG）
- **レスポンス**:
  ```json
  {
    "item": "コーヒー",
    "price": 500,
    "date": "2026-01-28",
    "confidence": 0.95
  }
  ```
- **エラーハンドリング**:
  - 400: ファイル形式不正、ファイルサイズ超過
  - 500: サーバーエラー、AI解析エラー

### 4.6. 評価API（11期機能統合）
- **エンドポイント**: `POST /api/expenses/{expense_id}/evaluate`
- **リクエストボディ**:
  ```json
  {
    "is_helpful": true
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": 1,
    "expense_id": 1,
    "user_id": 1,
    "is_helpful": true,
    "created_at": "2026-01-28T10:00:00Z"
  }
  ```

### 4.7. カテゴリAPI（11期機能統合）
- **エンドポイント**: `GET /api/categories`
- **レスポンス**:
  ```json
  [
    {
      "id": 1,
      "name": "食費",
      "parent_id": null,
      "path": "1",
      "level": 0
    },
    {
      "id": 2,
      "name": "外食",
      "parent_id": 1,
      "path": "1/2",
      "level": 1
    }
  ]
  ```

### 4.8. キーワード検索API（11期機能統合）
- **エンドポイント**: `GET /api/expenses/search?keyword={keyword}`
- **クエリパラメータ**:
  - `keyword`: 検索キーワード（必須）
- **レスポンス**:
  ```json
  {
    "results": [
      {
        "id": 1,
        "item": "コーヒー",
        "price": 500,
        "matched_keyword": "コーヒー"
      }
    ],
    "total": 1
  }
  ```

### 4.9. 検出履歴API（11期機能統合）
- **エンドポイント**: `GET /api/detection-histories`
- **レスポンス**:
  ```json
  [
    {
      "id": "uuid-here",
      "user_id": 1,
      "uploaded_files_count": 3,
      "detected_subscriptions_count": 5,
      "total_monthly_amount": 5000,
      "created_at": "2026-01-28T10:00:00Z"
    }
  ]
  ```

### 4.10. 明細書解析API（拡張版・11期機能統合）
- **エンドポイント**: `POST /api/analyze/files`
- **リクエスト**:
  - Content-Type: `multipart/form-data`
  - `files`: ファイル配列（PDF, 画像, CSV）
- **レスポンス**:
  ```json
  {
    "detection_history_id": "uuid-here",
    "detected_subscriptions": [
      {
        "name": "Netflix",
        "monthly_price": 990,
        "confidence": 0.95
      }
    ],
    "total_monthly_amount": 5000
  }
  ```

---

## 5. UI/UX要件

### 5.1. デザイン方針
- モダンで洗練されたUI/UX
- レスポンシブデザイン（モバイル・タブレット・PC対応）
- アクセシビリティを考慮した設計

### 5.2. 主要画面
- **ログイン画面**: メールアドレス（またはユーザーID）とパスワード入力
- **支出記録画面**: 入力フォームと履歴表示
- **分析画面**: AIコーチング結果の表示

### 5.3. UI生成方法
- Figma make/code生成を活用
- デザインリード（なおみん）が主導

---

## 6. 「11期レベル」の定義

### 6.1. 必須項目
- **型安全性**: TypeScript（フロントエンド）、Pydantic（バックエンド）による型チェック
- **エラーハンドリング**: 適切なエラーメッセージとHTTPステータスコード
- **コード品質**: リント・フォーマットの統一

### 6.2. 推奨項目
- **テスト**: ユニットテスト・統合テスト（可能な範囲で）
- **ドキュメント**: API仕様書（OpenAPI/Swagger）
- **CI/CD**: GitHub Actionsによる自動テスト・デプロイ

---

## 7. スプリント計画

### Sprint 0（〜2/3）
準備期。**機能一覧・データ定義を先に固め、テーブルは最初に作成する**。途中からのマイグレーションはチーム全体の整合を取りづらいため、Sprint 0 でスキーマを確定し、Sprint 1 では「テーブルを触らない前提」で開発を始められるようにする。

- [ ] **機能一覧の作成・確定**
  - 本ドキュメント「2. 機能要件」をベースに、機能一覧を作成
  - Sprint 1 で実装する機能と Sprint 2 で実装する機能の切り分けを明記
- [ ] **データ定義・テーブル定義の確定**
  - 本ドキュメント「3. データモデル」をベースに、全テーブル定義を確定
  - Sprint 1 で使うテーブルと Sprint 2 で追加するテーブルの切り分けを明記
- [ ] **テーブルの作成（マイグレーション実行）**
  - 確定した定義で Azure MySQL 上にテーブルを作成

  - ※途中からのマイグレーションを避けるため、必要なテーブルは Sprint 0 で作成しておく
- [ ] **基本要件定義書の最終確認**
  - 本ドキュメント全体のレビュー
  - 機能要件・データモデル・API設計の整合性確認

### Sprint 1（2/4 〜 2/10）
Sprint 0 でテーブル・モックが揃っている前提で、必須機能の実装に集中する。

- [ ] **認証機能の実装**
  - ログイン・サインアップ・セッション管理
- [ ] **支出記録機能の実装**
  - API実装（FastAPI）
  - フロントエンド実装（Next.js）
- [ ] **分析機能（AIコーチング）の実装**
  - 合計計算ロジック
  - AIコーチング機能（OpenAI API）
- [ ] **基本UIの実装**
  - 入力フォーム
  - 分析ボタン・結果表示
- [ ] （テーブルは Sprint 0 で作成済みのため、新規マイグレーションは原則不要）

### Sprint 2（2/11 〜 2/17）
追加機能の実装と最終調整。

- [ ] **履歴表示機能**
- [ ] **予算設定機能**
- [ ] **11期機能統合**（優先度順）
  - レシート画像の自動認識・入力（最高優先度）
  - サービス名正規化（最高優先度）
  - 評価機能（高優先度）
  - 明細書解析の拡張（高優先度）
  - カテゴリ分類（中優先度）
  - キーワード検索（中優先度）
  - 検出履歴管理（中優先度）
- [ ] **レポート機能**（オプション、時間があれば）
- [ ] **最終調整・デプロイ**

---

## 8. 非機能要件

非機能要件は別紙 [非機能要件](./非機能要件.md) を参照すること。

---

## 9. 制約事項

### 9.1. 技術的制約
- Azure MySQLを使用（データベース選択の制約）
- OpenAI APIの継続利用（gen12と同様）

### 9.2. スケジュール制約
- 最終納期: 2月17日
- チームメンバーの疲弊状態を考慮した省エネ開発

### 9.3. リソース制約
- 最小限のリソースで最大の成果を出す
- AI駆動ワークフローによる効率化

### 9.4. 開発方針（データベース）
- **テーブルは Sprint 0 で定義・作成する**
- 前回開発では途中からのマイグレーションが負荷となり、チーム全体でスキーマを揃えるのが難しかった経験がある
- そのため、必要なテーブル定義を Sprint 0 で確定し、Sprint 1 開始時点でテーブルが存在している状態にする
- Sprint 1 以降は原則として新規テーブル追加のみ（既存テーブルの変更は最小限に抑える）

---

## 10. 参考資料

- [12期アプリの現状分析](../reference/gen12_current_state.md)
- [プロジェクトコンテキスト](../reference/PROJECT_CONTEXT.md)
- [11期チームアプリ機能分析サマリー](../reference/11期チームアプリ機能分析_サマリー.md)
  - [くんよみ機能分析](../reference/11期チームアプリ機能分析_くんよみ.md)
  - [MOF機能分析](../reference/11期チームアプリ機能分析_MOF.md)
  - [wasabimonja機能分析](../reference/11期チームアプリ機能分析_wasabimonja.md)

---

**作成日**: 2026年1月28日
**最終更新**: 2026年1月28日（11期チームアプリ機能分析を反映）
**作成者**: しゅんすけ